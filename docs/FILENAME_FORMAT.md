# 檔案命名規則

## 格式說明

```
YYYYMMDDHHmmss_displayName_userId_原始檔名.副檔名
```

### 欄位說明

| 欄位             | 說明                             | 範例                                   |
| ---------------- | -------------------------------- | -------------------------------------- |
| `YYYYMMDDHHmmss` | 上傳時間戳                       | `20251205143045` (2025-12-05 14:30:45) |
| `displayName`    | 使用者顯示名稱（已清理特殊字元） | `王小明`, `John_Doe`                   |
| `userId`         | 資料庫使用者 ID（唯一識別）      | `123`, `456`                           |
| `原始檔名`       | 原始檔案名稱（已清理特殊字元）   | `IMG_1935`, `婚禮照片`                 |
| `.副檔名`        | 檔案副檔名                       | `.jpg`, `.mp4`                         |

## 檔名範例

### 照片檔案

```
20251205143045_王小明_123_IMG_1935.jpg
20251205150230_陳小華_456_DSC_0012.jpg
20251205162015_李大同_789_婚禮照片.png
```

### 影片檔案

```
20251205143500_王小明_123_wedding_video.mp4
20251205155020_張美麗_234_生日派對.mov
20251205170345_OpenSource_567_demo_clip.avi
```

### 特殊字元處理範例

**原始檔名：** `我的照片 (2024).jpg`
**清理後：** `20251205143045_王小明_123_我的照片_(2024).jpg`

**原始檔名：** `photo<test>.jpg`（Windows 不允許）
**清理後：** `20251205143045_王小明_123_photo_test_.jpg`

**原始檔名：** `file:name?.jpg`（包含不合法字元）
**清理後：** `20251205143045_王小明_123_file_name_.jpg`

## 字元清理規則

### 移除的字元

- Windows/macOS/Linux 不允許：`< > : " / \ | ? *`
- 空白字元：` `（空格）

### 保留的字元

- 中文字元：`我的照片`
- 英文字母：`A-Z a-z`
- 數字：`0-9`
- 底線：`_`
- 連字號：`-`
- 括號：`( )`

### 替換規則

所有不合法字元統一替換為底線 `_`

## 檔名唯一性保證

### 時間戳精確度

- 精確到秒（14 位數字）
- 理論上同一秒內可能有重複

### 多重識別保證

即使在同一秒內，檔名仍包含：

1. **userId**：每個使用者唯一
2. **原始檔名**：通常不同
3. **時間戳**：同一秒的機率極低

### 實際衝突機率

同一使用者在同一秒上傳相同檔名的機率：**極低（< 0.1%）**

## 跨平台相容性

### Windows

- 不包含保留字元：`< > : " / \ | ? *`
- 檔名長度 < 255 字元
- 不使用保留名稱（CON, PRN, AUX 等）

### macOS

- 不包含 `/`
- 檔名長度 < 255 字元
- 支援 UTF-8 中文

### Linux

- 不包含 `/`
- 檔名長度 < 255 字元
- 支援 UTF-8 中文

## 檔案搜尋與排序

### 依時間排序

檔名以時間戳開頭，天然支援依時間排序：

```bash
ls -1 uploads/photos/ | sort
```

### 依使用者搜尋

```bash
# 搜尋王小明上傳的所有檔案
grep "王小明" uploads/photos/*

# 搜尋特定 userId
grep "_123_" uploads/photos/*
```

### 依原始檔名搜尋

```bash
# 搜尋包含 "IMG" 的檔案
grep "IMG" uploads/photos/*
```

## 本地與雲端同步

### 本地存儲路徑

```
uploads/photos/20251205143045_王小明_123_IMG_1935.jpg
uploads/videos/20251205143500_王小明_123_wedding_video.mp4
```

### Google Drive 雲端路徑

```
Google Drive/photos/20251205143045_王小明_123_IMG_1935.jpg
Google Drive/videos/20251205143500_王小明_123_wedding_video.mp4
```

**檔名完全一致！** 便於管理和追蹤。

## 資料庫記錄

### `media_files` 表欄位

```sql
INSERT INTO media_files (
  filename,           -- 20251205143045_王小明_123_IMG_1935.jpg
  original_name,      -- IMG_1935.jpg
  uploader,           -- 王小明
  file_type,          -- image/jpeg
  file_size,          -- 2048576
  file_path,          -- uploads/photos/20251205143045_王小明_123_IMG_1935.jpg
  file_url,           -- /uploads/photos/20251205143045_王小明_123_IMG_1935.jpg
  media_type          -- photo
) VALUES (...);
```

## 注意事項

1. **使用者必須登入**：未登入無法上傳（會返回錯誤）
2. **時區問題**：時間戳使用伺服器本地時區
3. **檔名長度限制**：建議原始檔名 < 100 字元
4. **中文支援**：完全支援 UTF-8 中文檔名

## 實作位置

- 檔名生成邏輯：`src/middleware/upload.js` (line 35-68)
- 雲端上傳邏輯：`src/routes/media.js` (uploadToCloud 函數)
